{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{% static 'styles/dashboard.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'styles/sidebar.css' %}" />
  </head>
  <body>
    <!-- Sidebar -->
    {% include 'includes/adminsidebar.html' %}

    <!-- Main Content -->
    <div class="content">
      <!-- Top Bar -->
      <div class="top-bar">
        <h2>Welcome back, Admin ðŸ‘‹</h2>
        <div class="notification">
          <button id="notifBtn" class="bell-btn">
            ðŸ”” {% if unread_count > 0 %}
            <span class="badge">{{ unread_count }}</span>
            {% endif %} 
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <h4>Notifications</h4>
            <ul>
              {% for note in notifications %}
              <li>
                {{ note.message }} <br />
                <small>{{ note.created_at|date:"M d, Y H:i" }}</small>
                <form
                  method="post"
                  action="{% url 'mark_notification_read' note.id %}"
                >
                  {% csrf_token %}
                  <button type="submit" class="mark-btn">Mark as read</button>
                </form>
              </li>
              {% empty %}
              <li>No new notifications</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Cards -->
      <div class="cards">
        <div class="card">
          <h2>ADMINS</h2>
          <p>{{ stats.admins|default:0 }}</p>
        </div>
        <div class="card">
          <h2>PENRO</h2>
          <p>{{ stats.penros|default:0 }}</p>
        </div>
        <div class="card">
          <h2>CENRO</h2>
          <p>{{ stats.cenros|default:0 }}</p>
        </div>
        <div class="card">
          <h2>EVALUATORS</h2>
          <p>{{ stats.evaluators|default:0 }}</p>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="chart-container">
          <h3>Report Status Overview</h3>
          <canvas id="userChart" data-admins="{{ stats.admins|default:0 }}" data-penros="{{ stats.penros|default:0 }}" data-cenros="{{ stats.cenros|default:0 }}" data-evaluators="{{ stats.evaluators|default:0 }}"></canvas>
        </div>
        <div class="chart-container">
          <h3>Account Status</h3>
          <canvas id="accountStatusChart" data-approved="{{ stats.approved_users|default:0 }}" data-pending="{{ stats.pending_users|default:0 }}" data-rejected="{{ stats.rejected_users|default:0 }}" data-deactivated="{{ stats.deactivated_users|default:0 }}"></canvas>
        </div>
      </div>

      <!-- Recent Users -->
      <div class="section-title">Recent Users</div>
      <div class="table-wrap">
        <table>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Last Login</th>
          </tr>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.last_login|default:"Never" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">No users found</td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Activity Logs Section -->
      <!-- <div class="section-title">Activity Logs</div>
      <div class="filters">
        <form method="get" action="{% url 'admin_activitylogs' %}">
          <input type="text" name="q" placeholder="Search..." value="{{ request.GET.q }}">
          <select name="role">
            <option value="">All Roles</option>
            <option value="ADMIN" {% if request.GET.role == 'ADMIN' %}selected{% endif %}>Admin</option>
            <option value="PENRO" {% if request.GET.role == 'PENRO' %}selected{% endif %}>PENRO</option>
            <option value="CENRO" {% if request.GET.role == 'CENRO' %}selected{% endif %}>CENRO</option>
            <option value="EVALUATOR" {% if request.GET.role == 'EVALUATOR' %}selected{% endif %}>Evaluator</option>
          </select>
          <input type="text" name="action" placeholder="Action" value="{{ request.GET.action }}">
          <input type="date" name="from" value="{{ request.GET.from }}">
          <input type="date" name="to" value="{{ request.GET.to }}">
          <button type="submit">Filter</button>
        </form>
      </div> -->

      <!-- Activity Logs Table -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Action</th>
              <th>Details</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
              <td>{{ log.user.username }}</td>
              <td>{{ log.action }}</td>
              <td>{{ log.details }}</td>
              <td>{{ log.latitude }}</td>
              <td>{{ log.longitude }}</td>
              <td>{{ log.created_at|date:"M d, Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6">No logs found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
        {% endif %}
        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
        {% endif %}
      </div>
    </div>

    <!-- JS -->
    <script src="{% static 'js/admin_dashboard.js' %}"></script>
  </body>
</html>
