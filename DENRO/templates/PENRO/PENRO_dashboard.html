{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PENRO Dashboard</title>
  <link rel="stylesheet" href="{% static 'styles/dashboard.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'styles/sidebar.css' %}" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body>
    <!-- Sidebar -->
    {% include 'includes/sidenav/sidenav_penro.html' %}

    <!-- Main Content -->
    <div class="content">
      <!-- Top Bar -->
      <div class="top-bar">
        <h2>Welcome back, PENRO ðŸ‘‹</h2>
        <div class="notification">
          <button id="notifBtn" class="bell-btn">
            ðŸ”” {% if unread_count > 0 %}
            <span class="badge">{{ unread_count }}</span>
            {% endif %}
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <h4>Notifications</h4>
            <ul>
              {% for note in notifications %}
              <li>
                {{ note.message }} <br />
                <small>{{ note.created_at|date:"M d, Y H:i" }}</small>
                <form
                  method="post"
                  action="{% url 'mark_notification_read' note.id %}"
                >
                  {% csrf_token %}
                  <button type="submit" class="mark-btn">Mark as read</button>
                </form>
              </li>
              {% empty %}
              <li>No new notifications</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Cards -->
      <div class="cards">
        <div class="card">
          <h2>APPROVED</h2>
          <p>{{ stats.approved_users|default:0 }}</p>
        </div>
        <div class="card">
          <h2>REJECTED</h2>
          <p>{{ stats.rejected_users|default:0 }}</p>
        </div>
        <div class="card">
          <h2>PENDING</h2>
          <p>{{ stats.pending_users|default:0 }}</p>
        </div>
        <div class="card">
          <h2>EVALUATORS</h2>
          <p>{{ stats.evaluators|default:0 }}</p>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="chart-container">
          <h3>Report Status Overview</h3>
          <canvas id="reportStatusChart" data-pending="{{ stats.pending_reports|default:0 }}" data-accepted="{{ stats.accepted_reports|default:0 }}" data-declined="{{ stats.declined_reports|default:0 }}"></canvas>
        </div>
        <div class="chart-container">
          <h3>PENRO and Evaluator Last Login Locations (Including Yours)</h3>
          <div id="map" style="height: 300px; width: 100%;"></div>
        </div>
      </div>

      <!-- Recent Users -->
      <div class="section-title">Recent Users</div>
      <div class="table-wrap">
        <table>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Last Login</th>
          </tr>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.last_login|default:"Never" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">No users found</td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Activity Logs Section -->
      <div class="section-title">Activity Logs</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Action</th>
              <th>Details</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
              <td>{{ log.user.username }}</td>
              <td>{{ log.action }}</td>
              <td>{{ log.details }}</td>
              <td>{{ log.created_at|date:"M d, Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4">No logs found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- JS -->
    <script src="{% static 'js/admin_dashboard.js' %}"></script>
    <script>
      // Initialize map
      var map = L.map('map').setView([10.3157, 123.8854], 8); // Center on Region 7 (Central Visayas)

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Add markers for user locations
      {% for location in user_locations %}
        var marker = L.marker([{{ location.lat }}, {{ location.lon }}]).addTo(map);
        marker.bindPopup('<b>{{ location.username }}</b><br>Role: {{ location.role }}<br>Last Update: {{ location.last_update|date:"M d, Y H:i" }}');
      {% endfor %}

      // Add marker for current user location
      {% if current_user_location %}
        var currentMarker = L.marker([{{ current_user_location.lat }}, {{ current_user_location.lon }}], {icon: L.icon({iconUrl: '{% static 'images/Logo.png' %}', iconSize: [25, 25]})}).addTo(map);
        currentMarker.bindPopup('<b>You ({{ user.username }})</b><br>Last Update: {{ current_user_location.last_update|date:"M d, Y H:i" }}');
      {% endif %}

      // Add latitude and longitude control
      var latlngControl = L.control({position: 'bottomleft'});
      latlngControl.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'latlng-control');
        div.style.background = 'white';
        div.style.padding = '5px';
        div.style.border = '1px solid #ccc';
        div.style.borderRadius = '4px';
        div.innerHTML = 'Lat: -, Lng: -';
        return div;
      };
      latlngControl.addTo(map);

      map.on('mousemove', function(e) {
        var lat = e.latlng.lat.toFixed(5);
        var lng = e.latlng.lng.toFixed(5);
        document.querySelector('.latlng-control').innerHTML = 'Lat: ' + lat + ', Lng: ' + lng;
      });
    </script>
  </body>
</html>
